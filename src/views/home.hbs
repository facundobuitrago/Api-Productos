<section>
  <h1 style="text-align:center; font-size:32px; margin:10px 0 24px;">Lista de Productos</h1>

  <!-- GRID DE PRODUCTOS -->
  <ul id="products-list" style="
    list-style:none;
    padding:0;
    margin:0 auto 32px;
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(260px, 1fr));
    gap:20px;">
    
    {{#each products}}
    <li class="product" data-product-id="{{_id}}" style="
      background:#111827;
      border-radius:18px;
      padding:18px;
      box-shadow:0 14px 35px rgba(0,0,0,.45);
      border:1px solid #1f2937;">

      <h2 style="margin:0 0 4px; font-size:19px; font-weight:600;">{{nombre}}</h2>

      <p style="margin:0 0 10px; color:#9ca3af; font-size:13px;">
        {{descripcion}}
      </p>

      <p><strong>Precio:</strong> ${{precio}}</p>

      <!-- üî• ESTO ES IMPORTANTE: stock con CLASE .stock -->
      <p class="stock" style="margin:4px 0 14px;">
        Stock: {{stock}}
      </p>

      <!-- Agregar al carrito -->
      <form action="/add-to-cart" method="POST" style="display:inline;">
        <input type="hidden" name="productId" value="{{_id}}">
        <button type="submit" class="btn btn-primary">Agregar</button>
      </form>

      <!-- Eliminar producto (socket) -->
      <button
        type="button"
        class="btn btn-ghost delete-btn"
        data-product-id="{{_id}}"
        style="margin-left:8px;">
        Eliminar
      </button>
    </li>
    {{/each}}
  </ul>
</section>

<!-- Form NUEVO PRODUCTO -->
<section style="
  max-width:600px;
  margin:0 auto 24px;
  background:#111827;
  padding:20px 22px;
  border-radius:18px;
  border:1px solid #1f2937;
  box-shadow:0 14px 35px rgba(0,0,0,.45);">

  <h2 style="margin-top:0;margin-bottom:14px;font-size:20px;">Agregar nuevo producto</h2>

  <form id="add-product-form">
    <label>Nombre:</label>
    <input type="text" id="nombre" class="input-dark">

    <label>Descripci√≥n:</label>
    <input type="text" id="descripcion" class="input-dark">

    <label>Precio:</label>
    <input type="number" id="precio" class="input-dark">

    <label>Cantidad:</label>
    <input type="number" id="stock" class="input-dark">

    <button id="add-product-button" class="btn btn-primary" style="width:100%;margin-top:4px;">
      Agregar
    </button>
  </form>
</section>

<div style="text-align:center;margin-top:8px;">
  <a href="/real-time-products">
    <button class="btn btn-ghost">Ver Productos en Tiempo Real</button>
  </a>
</div>

<!-- TOAST -->
<div id="toast" class="toast" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #2d3436;
    color: #fff;
    padding: 10px 20px;
    border-radius: 8px;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 9999;
    pointer-events:none;">
</div>

<!-- SCRIPTS (UNA SOLA VEZ) -->
<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

// =========================
// üî• FUNCTION TOAST
// =========================
function showToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.style.opacity = "1";
    setTimeout(() => t.style.opacity = "0", 2000);
}

// =========================
// üî• STOCK BAJO DE ENTRADA
// =========================
document.querySelectorAll(".stock").forEach(el => {
    const num = parseInt(el.textContent.replace(/\D/g, ""));
    if (num <= 1) {
        el.style.color = "#ff7675";
        el.style.fontWeight = "bold";
    }
});

// =========================
// üî• STOCK ACTUALIZADO EN VIVO
// =========================
socket.on("stock-actualizado", ({ productId, newStock }) => {

    const item = document.querySelector(`[data-product-id="${productId}"]`);

    if (!item) return;

    const stockTag = item.querySelector(".stock");
    if (!stockTag) return;

    stockTag.textContent = "Stock: " + newStock;

    if (newStock <= 1) {
        stockTag.style.color = "#ff7675";
        stockTag.style.fontWeight = "bold";
    } else {
        stockTag.style.color = "#fff";
        stockTag.style.fontWeight = "normal";
    }

    showToast("Stock actualizado");
});

// =========================
// üî• ELIMINAR PRODUCTO
// =========================
document.addEventListener("click", (event) => {
    if (event.target.classList.contains("delete-btn")) {
        const productId = event.target.dataset.productId;
        socket.emit("delete-product", productId);
        showToast("Producto eliminado");
    }
});

// =========================
// üî• AGREGAR PRODUCTO (NUEVO)
// =========================
document.getElementById("add-product-form").addEventListener("submit", (e) => {
    e.preventDefault();

    const inputNombre = document.getElementById("nombre");
    const inputDescripcion = document.getElementById("descripcion");
    const inputPrecio = document.getElementById("precio");
    const inputStock = document.getElementById("stock");

    const nombre = inputNombre.value.trim();
    const descripcion = inputDescripcion.value.trim();
    const precio = parseFloat(inputPrecio.value);
    const stock = parseInt(inputStock.value);

    if (!nombre || !descripcion || isNaN(precio) || isNaN(stock)) {
      alert("Completa todos los campos correctamente.");
      return;
    }

    socket.emit("add-product", { nombre, descripcion, precio, stock });

    showToast("Producto agregado");
    e.target.reset();
});

// =========================
// üî• ACTUALIZAR LISTA COMPLETA
// =========================
socket.on("productos-actuales", (productos) => {
    const list = document.getElementById("products-list");
    list.innerHTML = "";

    productos.forEach(p => {
        const li = document.createElement("li");
        li.className = "product";
        li.dataset.productId = p._id;
        li.style.background = "#111827";
        li.style.borderRadius = "18px";
        li.style.padding = "18px";
        li.style.boxShadow = "0 14px 35px rgba(0,0,0,.45)";
        li.style.border = "1px solid #1f2937";

        li.innerHTML = `
          <h2 style="margin:0 0 4px;font-size:19px;font-weight:600;">${p.nombre}</h2>
          <p style="margin:0 0 10px;color:#9ca3af;font-size:13px;">${p.descripcion}</p>
          <p><strong>Precio:</strong> $${p.precio}</p>
          <p class="stock" style="margin:4px 0 14px;">Stock: ${p.stock}</p>

          <form action="/add-to-cart" method="POST" style="display:inline;">
            <input type="hidden" name="productId" value="${p._id}">
            <button type="submit" class="btn btn-primary">Agregar</button>
          </form>

          <button type="button" class="btn btn-ghost delete-btn" data-product-id="${p._id}" style="margin-left:8px;">
            Eliminar
          </button>
        `;

        list.appendChild(li);
    });
});
</script>
